id: git3
title: 小伙伴们的Git Flow(实验室版)
categories: teamwork
tags: [git,team]
---

## 分支组成

### master

这是一个神圣的分支，不允许亵渎。

- 不接受直接提交
- 变动应全部来自 `merge`
- 每次 `merge` 对应一个 **Tag** ，对应一次 **上线**



### dev

全部的测试过的代码都在这里。

- 拥有整个资源库 **最全** 的代码
- 代码应该经过测试
- 特殊情况下接受直接提交，原则是小改动（比如一个文件，几行代码）
- 主要代码来源于 `merge`



### feature

需求分支， 根据需求划分并从 **dev** 分支上检出。一般的在迭代开始我们会新建一些 **feature**.

- 命名推荐使用英文关键字，下划线打底：*sync_property_building_year*
- 从 **dev** 上检出
- 按需求划分
- 开发完成后直接测试，复杂情况参考 **release**
- 排入上线计划后，由 **测试** 合并到 **dev** , 在计划内所有 **feature** 都合并完后， 由 **测试** 合并入 **master**
- 周期结束删除



### release

在测试 **feature** 时遇到 **测试大大们** 打架时，可以使用此分支。

假设上线计划中有 **F1** **F2** **F3** 三个 **feature** ，并且同时测试，互相影响很不愉快。

在确定上线的前提下，我们根据 **F1** 检出并创建一个 **release** 分支， 然后将 **F2** **F3** 都并入 **release** ，大家一起测试 **release** 分支

- 测试冲突的分支都要上线
- 根据哪个 **feature** 首次创建 **release**？ 在选择上没什么道理的推荐使用改动量较多的分支作为 **release** 的基础 ，其他分支并入
- 命名推荐使用 release 加上线日：*release\_20170405*
- 周期结束删除



### hotfix

特殊情况下使用， 专治各种不服。

使用条件：因 **BUG** 而紧急修复；因 **政策** 而紧急发布；其他。

使用方法：直接从 **master** 检出，修改测试后合并回 **dev** 和 **master** , 打 **Tag** 上线。

- 紧急情况下灵活使用，原则是注意前置代码。
- 修改后一定要分别合并到 **dev** 和 **master**
- 命名推荐使用 hotfix 加英文关键词： *hotfix_add_source*
- 使用后删除



## 我们的约定

在上一个上线日结束到下一个上线日结束之间，称为一个 **Git开发周期**。

### GIT开发周期

周期包括分支开发、上线计划、上线准备几个阶段。

一般的我们遵循只在 **分支开发** 阶段从 **dev** 检出，只在 **上线计划** 阶段合并到 **dev** ， 只在 **上线准备** 阶段合并到 **master** ，不遵循此原则时应当考虑是否需要使用 **hotfix** 。

#### 分支开发

周期开始时从 **dev** 按照 *每个需求一个分支* 的原则创建新的 **feature** 分支，独立开发并测试。测试完成后保持分支不变，不立刻做合并 **dev** 的动作。

#### 上线计划

通常在上线日前一天，确定项目的上线计划（如果能更早确定则更好）。上线计划确定本次要上线的分支，并由 **测试同学** 将计划中的分支合并到 **dev** 上进行集成测试。集成测试结束即表示进入下一阶段。

#### 上线准备

集成测试后由 **测试同学** 将 **dev** 合并到 **master** 并打 **Tag**。修改 **Jenkins** 配置，准备上线单。

一般的认为打 **Tag** 是一个 **Git开发周期** 的结束，表示可以开始下一个周期。

![Git开发周期](http://7xrbi6.com1.z0.glb.clouddn.com/git-2.JPG)

### 几个场景

针对一个项目，我们考虑几种常见场景。

> 定义几个简称：
>
> master -> M    
> dev -> D   
> feature -> F

#### 不同需求上线日期不同

在 **分支开发** 阶段，我们根据需求从 **dev** 上检出并创建需求分支 **F1** **F2** 。**F1** 要在本周一上线， **F2** 要在本周三上线。

首先，**F1** **F2** 各自开发并完成测试。因为这个 **上线计划** 已经明确：上线 **F1**， 所以只向 **dev** 合并 **F1** , 确认无误后合并到 **master** 并打 **Tag**， 之后就可以将下个 **上线计划** 要上线的 **F2** 合并到 **dev**了。

*可参见开发周期图。*

#### 不同需求同一个应用， 但是某个需求动了基础的表结构

在 **分支开发** 阶段，我们根据需求从 **dev** 上检出并创建需求分支 **F1** **F2** 。在 **F1** 开发过程中需要变更数据库表结构，导致 **F2** 分支的代码无法正常运行，这种情况下怎么办呢？

如果 **F2** 开发可以等到 **F1** 开发完毕并测试完毕，那么将测试完毕的 **F1** 合并到 **F2**

如果 **F2** 很着急，那么将 **F1** 中涉及数据库表结构改动的代码 **commit** 通过 `cherry pick` 方式复制到 **F2** 中。

![分支影响](http://7xrbi6.com1.z0.glb.clouddn.com/git-1.JPG)

#### 特殊情况

遇到特殊情况可以喊小伙伴们一起帮忙~

### 操作人

创建**feature**由`开发`完成

将 **feature** 合并到 **dev** 由 `测试` 完成， `开发` 辅助

将 **dev** 合并到 **master** 并打 **Tag** 由 `测试` 完成

**hotfix** 相关操作原则： 谁创建谁负责，谁合并谁删除
