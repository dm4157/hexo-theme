id: git4
title: 小伙伴们的Git Flow(测试保障版)
categories: teamwork
tags: [git,team]
---

## 分支组成

### master
这是一个神圣的分支，不可亵渎。
- 不接受直接提交
- 变动应全部来自 *merge*
- 每次 *merge* 对应一个 **Tag** ，对应一次 **上线**

### release
全部的测试过的代码都在这里。相对于 **master** 多了一些下次上线的代码。
- 代码应该经过测试
- 代码来源于 `merge`
- 持久的，不删除

### feature
需求分支， 根据需求划分并从 **release** 分支上检出。一般的在迭代开始我们会新建一些 **feature**.
- 命名推荐使用英文关键字，下划线打底：sync_property_building_year
- 从 **release** 上检出
- 按需求划分
- 开发完成并 *CodeReview* 后由 `开发` 合并到 **test** 提测。
- 排入上线计划后，由 `测试` 合并到 **release** , 在计划内所有 **feature** 都合并完后，集成测试然后由 `测试` 合并入 **master**
- 周期结束删除

### test
部署在 *Jenkins* 上的分支，**feature** 开发完成后将代码合并到此分支。因此，*Jenkins* 上不需要变动分支，也不存在测试冲突问题。当测试出现 *bug* ，`开发` 应在对应的 **feature** 分支上修改，并合并到 **test** 分支验证。
- `测试` 的专属分支
- *Jenkins* 上常规部署分支
- 由 `开发` 从 **feature** 上合并代码，由 `测试` 部署验证
- 持久的，不删除

### hotfix
特殊情况下使用， 专治各种不服。
使用条件：因 *BUG* 而紧急修复；因 *政策* 而紧急发布；其他。
使用方法：直接从 **master** 检出，修改测试后合并回 **test**  、**release** 和 **master** , 打 **Tag** 上线。
- 紧急情况下灵活使用，原则是注意前置代码。
- 修改后一定要分别合并到 **test** 、 **release** 和 **master**
- 命名推荐使用 hotfix 加英文关键词： *hotfix_add_source*
- 测试时在 *Jenkins* 上直接部署 **hotfix** 分支并完成测试
- 使用后删除
- 上线日当晚修改可跳过 **hotfix** 直接在 **master** 上修改，发布无误后打 **Tag** 并将 **master** 合并到 **release** 和 **test**

## 我们的约定
在上一个上线日结束到下一个上线日结束之间，称为一个 *Git开发周期*。

> 定义几个简称：
>
> master -> M    
> release -> D(因为后面改名了，图中简称就不换了)   
> feature -> F

### GIT开发周期
周期包括分支开发、集中测试、上线计划、上线准备几个阶段。
一般的我们遵循只在 *分支开发* 阶段从 **release** 检出，只在 *上线计划* 阶段合并到 **release** ， 只在 *上线准备* 阶段合并到 **master** ，不遵循此原则时应当考虑是否需要使用 **hotfix** 。
#### 分支开发
周期开始时从 **release** 按照 *每个需求一个分支* 的原则创建新的 **feature** 分支，独立开发。
#### 分支测试
开发完成并且 *CodeReview* 后由 `开发` 合并到 **test** 分支，由 `测试` 部署验证。出现 *bug* 后 `开发` 在对应的 **feature** 分支上修复 *bug*，并将改动后的代码合并到 **test** 分支， 由 `测试` 验证，直到完成测试。
测试完成后保持 **feature** 分支不变，不立刻做合并 **release** 的动作。
#### 上线计划
通常在上线日前一天，确定项目的上线计划（如果能更早确定则更好）。上线计划确定本次要上线的分支，并由 `测试` 将计划中的分支合并到 **release** 上进行集成测试。集成测试结束即表示进入下一阶段。
#### 上线准备
集成测试后由 `测试`  将 **release** 合并到 **master** 并打 **Tag**。修改 **Jenkins** 配置，准备上线单。
一般的认为打 **Tag** 是一个 **Git开发周期** 的结束，表示可以开始下一个周期。
![周期](http://7xrbi6.com1.z0.glb.clouddn.com/git-t20.JPG)

### 几个场景

针对一个项目，我们考虑几种常见场景。

#### 不同需求上线日期不同
在 **分支开发** 阶段，我们根据需求从 **release** 上检出并创建需求分支 **F1** **F2** 。**F1** 要在本周一上线， **F2** 要在本周三上线。
首先，**F1** **F2** 各自开发。当 **F1** **F2** 提测后就将其合并到 **test** 分支测试。测试完成后根据确定的上线计划：上线 **F1**， 向 **release** 合并 **F1** , 确认无误后合并到 **master** 并打 **Tag**， 之后就可以将下个 **上线计划** 要上线的 **F2** 合并到 **release**了。
*可参见开发周期图。*

#### 不同需求变动了同一个地方， 影响了其他分支

在 **分支开发** 阶段，我们根据需求从 **release** 上检出并创建需求分支 **F1** **F2** 。在 **F1** 开发过程中需要变更数据库表结构，导致 **F2** 分支的代码无法正常运行，这种情况下怎么办呢？
如果 **F2** 开发可以等到 **F1** 开发完毕并测试完毕，那么将测试完毕的 **F1** 合并到 **F2**。
如果 **F2** 很着急，那么将 **F1** 中涉及数据库表结构改动的代码 **commit** 通过 `cherry pick` 方式复制到 **F2** 中。
![分支影响](http://7xrbi6.com1.z0.glb.clouddn.com/git-t1.JPG)
#### 特殊情况
遇到特殊情况可以喊小伙伴们一起帮忙~

### 操作人
创建 **feature** 由 `开发` 完成
将 **feature** 合并到 **test** 由 `开发` 完成
将 **feature** 合并到 **release** 由 `测试` 完成， `开发` 辅助
将 **release** 合并到 **master** 并打 **Tag** 由 `测试` 完成
**hotfix** 相关操作原则： 谁创建谁负责，谁合并谁删除
